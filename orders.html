<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>财务仪表盘 - 订单记录</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
    <!-- 导航栏 -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="#" data-widget="pushmenu"><i class="fas fa-bars"></i></a>
            </li>
        </ul>
    </nav>

    <!-- 侧边栏 -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <div class="sidebar">
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">
                            <i class="nav-icon fas fa-home"></i> 首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="users.html" class="nav-link">
                            <i class="nav-icon fas fa-users"></i> 用户管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="orders.html" class="nav-link active">
                            <i class="nav-icon fas fa-list"></i> 订单记录
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- 内容区 -->
    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <h1>订单记录</h1>
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <div class="input-group mb-2">
                            <input type="date" id="startDate" class="form-control" placeholder="开始日期">
                            <div class="input-group-append input-group-prepend">
                                <span class="input-group-text">至</span>
                            </div>
                            <input type="date" id="endDate" class="form-control" placeholder="结束日期">
                        </div>
                        <div class="input-group">
                            <input type="text" id="searchOrder" class="form-control" placeholder="搜索用户名...">
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="float-right">
                            <select id="sortField" class="form-control">
                                <option value="submitTime">提交时间</option>
                                <option value="orderDate">订单日期</option>
                                <option value="amount">金额</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">
                <div class="mb-3">
                    <button id="exportOrders" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> 导出订单数据
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>提交时间</th>
                                        <th>订单日期</th>
                                        <th>用户名</th>
                                        <th>金额</th>
                                        <th>类型</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="orderTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="main.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('Initializing database...');
        await initDB();
        console.log('Database initialized successfully');

        // 移除默认日期设置
        // const now = new Date();
        // const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        // const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        
        // document.getElementById('startDate').value = formatDate(firstDay);
        // document.getElementById('endDate').value = formatDate(lastDay);

        const loadOrders = async () => {
            try {
                console.log('Loading orders...');
                const orders = await getAllOrders();
                console.log('Retrieved orders:', orders);
                
                // 日期范围筛选（只在有选择日期时才筛选）
                let filteredOrders = orders;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999);
                    
                    filteredOrders = orders.filter(order => {
                        const orderDate = new Date(order.orderDate);
                        return orderDate >= start && orderDate <= end;
                    });
                }
                
                // 搜索用户名筛选
                const searchTerm = document.getElementById('searchOrder').value.toLowerCase();
                if (searchTerm) {
                    filteredOrders = filteredOrders.filter(order => 
                        order.userId.toLowerCase().includes(searchTerm)
                    );
                }
                
                // 排序
                const sortField = document.getElementById('sortField').value;
                filteredOrders.sort((a, b) => {
                    if (sortField === 'amount') {
                        return parseFloat(b.amount) - parseFloat(a.amount);
                    }
                    return new Date(b[sortField]) - new Date(a[sortField]);
                });
                
                // 渲染表格
                const tbody = document.getElementById('orderTableBody');
                tbody.innerHTML = filteredOrders.map(order => `
                    <tr class="${order.type === 'deposit' ? 'table-info' : 'table-danger'}">
                        <td>${new Date(order.submitTime).toLocaleString()}</td>
                        <td>${new Date(order.orderDate).toLocaleDateString()}</td>
                        <td>${order.userId}</td>
                        <td>${parseFloat(order.amount).toFixed(2)}</td>
                        <td>${order.type === 'deposit' ? '充值' : '出款'}</td>
                        <td>
                            <button class="btn btn-danger btn-sm delete-order" 
                                    data-order-id="${order.id}">删除</button>
                        </td>
                    </tr>
                `).join('');

                // 添加合计行
                const totals = filteredOrders.reduce((acc, order) => {
                    if (order.type === 'deposit') {
                        acc.deposit += parseFloat(order.amount);
                    } else {
                        acc.withdrawal += parseFloat(order.amount);
                    }
                    return acc;
                }, { deposit: 0, withdrawal: 0 });

                tbody.innerHTML += `
                    <tr class="font-weight-bold">
                        <td colspan="3">合计</td>
                        <td colspan="2">
                            充值：${totals.deposit.toFixed(2)}<br>
                            出款：${totals.withdrawal.toFixed(2)}<br>
                            净额：${(totals.deposit - totals.withdrawal).toFixed(2)}
                        </td>
                        <td></td>
                    </tr>
                `;
                
                console.log('Orders table updated successfully');
            } catch (error) {
                console.error('Error loading orders:', error);
                alert('加载订单失败：' + error.message);
            }
        };

        // 绑定事件
        document.getElementById('startDate').addEventListener('change', loadOrders);
        document.getElementById('endDate').addEventListener('change', loadOrders);
        document.getElementById('searchOrder').addEventListener('input', loadOrders);
        document.getElementById('sortField').addEventListener('change', loadOrders);
        
        // 删除订单
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-order')) {
                try {
                    const orderId = parseInt(e.target.dataset.orderId);
                    console.log('Attempting to delete order:', orderId);
                    
                    if (confirm('确认删除此订单吗？此操作将同步更新用户统计数据')) {
                        await deleteOrder(orderId);
                        console.log('Order deleted successfully');
                        await loadOrders();
                        alert('订单已删除');
                    }
                } catch (error) {
                    console.error('Error deleting order:', error);
                    alert('删除失败：' + error.message);
                }
            }
        });

        // 添加导出功能
        const exportToExcel = (data, filename) => {
            const headers = ['提交时间', '订单日期', '用户名', '金额', '类型'];
            let csvContent = '\uFEFF' + headers.join(',') + '\n'; // 添加 BOM 以支持中文

            data.forEach(item => {
                const row = [
                    new Date(item.submitTime).toLocaleString(),
                    new Date(item.orderDate).toLocaleDateString(),
                    item.userId,
                    parseFloat(item.amount).toFixed(2),
                    item.type === 'deposit' ? '充值' : '出款'
                ];
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        };

        document.getElementById('exportOrders').addEventListener('click', async () => {
            try {
                const orders = await getAllOrders();
                exportToExcel(orders, `订单数据_${new Date().toLocaleDateString()}.csv`);
            } catch (error) {
                console.error('导出失败：', error);
                alert('导出失败：' + error.message);
            }
        });

        // 初始加载
        await loadOrders();
        console.log('Initial orders loaded successfully');
    } catch (error) {
        console.error('Initialization error:', error);
        alert('系统初始化失败：' + error.message);
    }
});
</script>
</body>
</html>